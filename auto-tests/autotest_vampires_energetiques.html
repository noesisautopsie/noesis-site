<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto-√âvaluation Relations √âpuisantes ‚Äî NO√âSIS</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@300;400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --noir-absolu:#0A0A0A; --creme-principal:#F7F5EF; --blanc-surface:#FFFFFF;
      --or-signature:#C7A86D; --or-riche:#D4B980; --or-subtil:rgba(199,168,109,.08);
      --fs-sm:14px; --fs-md:18px; --fs-lg:21px; --fs-xl:24px; --fs-2xl:32px; --fs-3xl:42px;
      --s-2:8px; --s-3:12px; --s-4:16px; --s-6:24px; --s-8:32px; --s-12:48px;
      --shadow-large:0 8px 32px rgba(10,10,10,.12), 0 2px 8px rgba(10,10,10,.18);
      --radius-md:8px; --radius-2xl:24px; --radius-pill:9999px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Arial,sans-serif;font-size:var(--fs-md);line-height:1.7;color:var(--noir-absolu);background:var(--creme-principal)}
    h1,h2{font-family:Fraunces,serif;font-weight:600}
    .app-container{max-width:900px;margin:0 auto;padding:var(--s-12) var(--s-6)}
    .screen{display:none;animation:fadeIn .25s ease}
    .screen.active{display:block}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .header{text-align:center;margin-bottom:var(--s-12)}
    .card{background:var(--blanc-surface);border-radius:var(--radius-2xl);padding:var(--s-12);margin-bottom:var(--s-8);box-shadow:var(--shadow-large)}
    .warning-box{background:#fffbeb;border-left:4px solid var(--or-signature);border-radius:var(--radius-md);padding:var(--s-6);margin-bottom:var(--s-8)}
    .danger-box{background:#fef2f2;border-left:4px solid #dc2626;border-radius:var(--radius-md);padding:var(--s-6);margin-bottom:var(--s-8)}
    .btn{padding:var(--s-4) var(--s-8);border:none;border-radius:var(--radius-md);font-size:var(--fs-md);font-weight:600;cursor:pointer;transition:all .25s;box-shadow:0 2px 8px rgba(10,10,10,.08)}
    .btn-primary{background:var(--or-signature);color:var(--blanc-surface)}
    .btn-primary:disabled{opacity:.4;cursor:not-allowed}
    .btn-secondary{background:transparent;color:var(--or-signature);border:2px solid var(--or-signature)}
    .form-group{display:flex;flex-direction:column;gap:var(--s-2);margin-bottom:var(--s-6)}
    .form-select,.form-input{padding:var(--s-4);border:2px solid rgba(10,10,10,.12);border-radius:var(--radius-md);font-size:var(--fs-md)}
    .consent-container{margin-top:var(--s-8);padding:var(--s-6);background:var(--or-subtil);border-radius:var(--radius-md)}
    .progress-container{position:fixed;top:0;left:0;right:0;background:var(--blanc-surface);padding:var(--s-4);z-index:1000;box-shadow:0 2px 8px rgba(10,10,10,.08)}
    .progress-bar{height:4px;background:var(--creme-principal);border-radius:var(--radius-pill);overflow:hidden}
    .progress-fill{height:100%;background:var(--or-signature);transition:width .35s cubic-bezier(.16,1,.3,1)}
    .question-container{margin-top:80px;padding-bottom:var(--s-12)}
    .question-card{background:var(--blanc-surface);border-radius:var(--radius-2xl);padding:var(--s-12);box-shadow:var(--shadow-large)}
    .question-text{font-size:var(--fs-lg);margin-bottom:var(--s-8);line-height:1.7}
    .answer-option{background:var(--blanc-surface);border:2px solid rgba(10,10,10,.12);border-radius:var(--radius-md);padding:var(--s-4);margin-bottom:var(--s-3);cursor:pointer;transition:all .25s;display:flex;justify-content:space-between;align-items:center}
    .answer-option:hover{border-color:rgba(10,10,10,.18);transform:translateX(4px)}
    .answer-option.selected{background:var(--or-subtil);border:2px solid var(--or-signature);transform:scale(1.02)}
    .option-label{font-weight:600;margin-bottom:var(--s-2)}
    .option-sublabel{font-size:var(--fs-sm);color:rgba(10,10,10,.7)}
    .question-nav{display:flex;gap:var(--s-4);margin-top:var(--s-8);justify-content:space-between}
    .score-circle-container{display:flex;justify-content:center;margin:var(--s-8) 0}
    .dimension-bar{display:flex;flex-direction:column;gap:var(--s-2);margin-bottom:var(--s-4)}
    .dimension-bar-track{height:12px;background:var(--creme-principal);border-radius:var(--radius-pill);overflow:hidden}
    .dimension-bar-fill{height:100%;border-radius:var(--radius-pill);transition:width 1.2s cubic-bezier(.16,1,.3,1)}
    .export-actions{display:flex;gap:var(--s-4);margin-top:var(--s-8);flex-wrap:wrap}
    @media(max-width:768px){.question-nav,.export-actions{flex-direction:column}.btn{width:100%}}
  </style>
</head>
<body>
  <div class="app-container">

    <!-- INTRO -->
    <div id="intro-screen" class="screen active">
      <div class="header">
        <h1>Auto-√âvaluation Relations √âpuisantes</h1>
        <p style="font-size:var(--fs-lg);color:rgba(10,10,10,.6)">Outil exploratoire d'identification de dynamiques relationnelles potentiellement toxiques</p>
      </div>

      <div class="warning-box">
        <h2>‚ö† Avertissement Important</h2>
        <p><strong>Cet outil est exploratoire et non diagnostique.</strong> Il ne remplace pas une consultation avec un professionnel. Les r√©sultats sont subjectifs.</p>
        <p><strong>En cas de violence :</strong> 3919 ‚Ä¢ 17 ‚Ä¢ 3114</p>
        <p><strong>Aucune donn√©e collect√©e.</strong> Tout reste local dans votre navigateur.</p>
      </div>

      <div class="danger-box">
        <h2>üîí S√©curit√© ‚Äî Emprise Active</h2>
        <p><strong>Si la personne surveille vos activit√©s en ligne</strong>, n'utilisez PAS cet outil sur votre appareil.</p>
      </div>

      <div class="card">
        <h2>M√©thodologie</h2>
        <p>√âvaluation de <strong>6 dimensions</strong> sur 40 items (10-12 min) :</p>
        <ul style="margin-left:20px;margin-top:12px;">
          <li>√âpuisement √ânerg√©tique</li>
          <li>Tactiques Drainantes & Asym√©tries</li>
          <li>Impact Neuro-Cognitif</li>
          <li>Fronti√®res & Consentement</li>
          <li>Retentissement Social/Professionnel</li>
          <li>R√©versibilit√©</li>
        </ul>
        <p style="margin-top:12px">Cadre th√©orique : Emprise psychologique, abus √©motionnel. <strong>Non valid√© psychom√©triquement.</strong></p>
      </div>

      <div class="card">
        <h2>Informations Contextuelles</h2>
        <div class="form-group">
          <label class="form-label">Type de relation √©valu√©e *</label>
          <select class="form-select" id="relation-type" required>
            <option value="">-- S√©lectionnez --</option>
            <option value="intime">Relation intime/conjugale</option>
            <option value="familiale">Relation familiale</option>
            <option value="amicale">Relation amicale</option>
            <option value="professionnelle">Relation professionnelle</option>
            <option value="aide">Relation d'aide</option>
            <option value="autre">Autre</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Dur√©e de la relation</label>
          <select class="form-select" id="relation-duration">
            <option value="">-- Non pr√©cis√© --</option>
            <option value="moins-6mois">Moins de 6 mois</option>
            <option value="6mois-2ans">6 mois √† 2 ans</option>
            <option value="2-5ans">2 √† 5 ans</option>
            <option value="plus-5ans">Plus de 5 ans</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Votre pr√©nom (optionnel)</label>
          <input type="text" class="form-input" id="user-name" placeholder="Anonyme" maxlength="50">
        </div>
      </div>

      <div class="consent-container">
        <label style="display:flex;gap:12px;align-items:flex-start;cursor:pointer">
          <input type="checkbox" id="consent-checkbox">
          <span>J'ai lu les avertissements. Je comprends que cet outil est exploratoire, non valid√© scientifiquement, et ne remplace pas une consultation professionnelle. Mes donn√©es restent locales.</span>
        </label>
      </div>

      <button class="btn btn-primary" id="start-btn" disabled style="width:100%;margin-top:24px">Commencer l'√âvaluation</button>
    </div>

    <!-- TEST -->
    <div id="test-screen" class="screen">
      <div class="progress-container">
        <div style="text-align:center;margin-bottom:8px;font-size:14px" id="progress-text">Question 1 / 40</div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
      </div>
      <div class="question-container" id="question-container"></div>
    </div>

    <!-- R√âSULTATS -->
    <div id="results-screen" class="screen">
      <div class="header"><h1>Vos R√©sultats</h1></div>

      <div class="card">
        <h2>Score Global</h2>
        <div class="score-circle-container" id="score-circle"></div>
        <div id="result-band"></div>
      </div>

      <div class="card">
        <h2>Analyse par Dimension</h2>
        <div id="dimension-bars"></div>
      </div>

      <div class="card">
        <h2>Profil Contextuel</h2>
        <div id="profile-summary"></div>
      </div>

      <div class="card">
        <h2>Recommandations</h2>
        <div id="recommendations"></div>
      </div>

      <div class="card" style="background:linear-gradient(135deg,#f0fdf4 0%,#ecfdf5 100%)">
        <h2>Ressources & Soutien</h2>
        <ul style="margin-left:20px">
          <li><strong>3919</strong> ‚Äî Violences Femmes Info (24/7)</li>
          <li><strong>119</strong> ‚Äî All√¥ Enfance en Danger</li>
          <li><strong>3114</strong> ‚Äî Pr√©vention Suicide</li>
        </ul>
      </div>

      <div class="export-actions">
        <button class="btn btn-primary" id="pdf-btn">üìÑ T√©l√©charger PDF</button>
        <button class="btn btn-secondary" id="email-btn">‚úâÔ∏è Envoyer Email</button>
        <button class="btn btn-secondary" id="json-btn">üìä Export JSON</button>
        <button class="btn btn-secondary" id="reset-btn">üîÑ Recommencer</button>
      </div>
    </div>

  </div>

  <script>
    // √âchelles, dimensions, questions et bandes
    const SCALE = [
      {v:0,l:"Jamais",s:"Absent ou tr√®s rare (<5%)"},
      {v:1,l:"Rarement",s:"Occasionnel (5-25%)"},
      {v:2,l:"Parfois",s:"R√©gulier (25-50%)"},
      {v:3,l:"Souvent",s:"Fr√©quent (50-75%)"},
      {v:4,l:"Quasi-syst√©matiquement",s:"Permanent (>75%)"}
    ];

    const DIMENSIONS = [
      {k:'epuisement',l:'√âpuisement',c:'#dc2626'},
      {k:'tactique',l:'Tactiques',c:'#ea580c'},
      {k:'cognitif',l:'Cognitif',c:'#7c3aed'},
      {k:'frontiere',l:'Fronti√®res',c:'#2563eb'},
      {k:'social',l:'Social',c:'#059669'},
      {k:'reversibilite',l:'R√©versibilit√©',c:'#10b981'}
    ];

    const QUESTIONS = [
      {id:'q1',dim:'epuisement',text:"Je me sens particuli√®rement fatigu√©¬∑e apr√®s avoir interagi avec cette personne."},
      {id:'q2',dim:'epuisement',text:"J'ai besoin de m'isoler ou me reposer apr√®s nos √©changes."},
      {id:'q3',dim:'epuisement',text:"Je ressens du stress ou de l'anxi√©t√© avant ses appels/messages."},
      {id:'q4',dim:'epuisement',text:"J'ai des sympt√¥mes physiques apr√®s nos interactions (maux de t√™te, tension...)."},
      {id:'q5',dim:'epuisement',text:"Mon √©nergie varie nettement selon sa pr√©sence ou absence."},
      {id:'q6',dim:'epuisement',text:"Je me r√©veille la nuit en pensant √† cette relation."},
      {id:'q7',dim:'epuisement',text:"Mes autres activit√©s sont affect√©es par la fatigue li√©e √† cette relation."},

      {id:'q8',dim:'tactique',text:"Elle monopolise mon temps de mani√®re disproportionn√©e."},
      {id:'q9',dim:'tactique',text:"Elle impose ses sujets sans s'int√©resser aux miens."},
      {id:'q10',dim:'tactique',text:"Elle dramatise pour obtenir une r√©ponse prioritaire."},
      {id:'q11',dim:'tactique',text:"Elle cr√©e des 'dettes morales' : je me sens redevable."},
      {id:'q12',dim:'tactique',text:"Elle requalifie mes refus comme des attaques."},
      {id:'q13',dim:'tactique',text:"Elle minimise ou d√©nigre mes besoins."},
      {id:'q14',dim:'tactique',text:"Elle demande des choses qui d√©passent mes capacit√©s r√©elles."},
      {id:'q15',dim:'tactique',text:"La personne reconna√Æt ses torts et cherche √† √©quilibrer la relation.",reverse:true},

      {id:'q16',dim:'cognitif',text:"Je rumine longuement apr√®s nos √©changes."},
      {id:'q17',dim:'cognitif',text:"Je suis en hypervigilance : j'anticipe ses r√©actions."},
      {id:'q18',dim:'cognitif',text:"J'ai des difficult√©s de concentration accrues."},
      {id:'q19',dim:'cognitif',text:"Je me censure pour √©viter ses r√©actions."},
      {id:'q20',dim:'cognitif',text:"Je doute de ma perception apr√®s qu'elle l'ait contest√©e."},
      {id:'q21',dim:'cognitif',text:"J'ai perdu de l'int√©r√™t pour mes projets personnels."},
      {id:'q22',dim:'cognitif',text:"Je me sens clairement mieux quand la relation est en pause.",reverse:true},

      {id:'q23',dim:'frontiere',text:"Mes limites sont test√©es puis ignor√©es."},
      {id:'q24',dim:'frontiere',text:"Quand je dis non, elle r√©agit par sanction √©motionnelle."},
      {id:'q25',dim:'frontiere',text:"Je donne syst√©matiquement plus que je re√ßois."},
      {id:'q26',dim:'frontiere',text:"Je m'excuse d'exister quand j'exprime un besoin."},
      {id:'q27',dim:'frontiere',text:"Je cache mon √©tat pour ne pas la contrarier."},
      {id:'q28',dim:'frontiere',text:"Je me sens responsable de son bien-√™tre √©motionnel."},
      {id:'q29',dim:'frontiere',text:"Je consens √† ses demandes pour √©viter un conflit.",critical:true},
      {id:'q30',dim:'frontiere',text:"Mes limites claires sont respect√©es durablement.",reverse:true},

      {id:'q31',dim:'social',text:"Mon entourage dit que je parais √©puis√©¬∑e ou chang√©¬∑e."},
      {id:'q32',dim:'social',text:"Mes t√¢ches pro/√©tudes sont retard√©es par ses sollicitations."},
      {id:'q33',dim:'social',text:"Elle me contacte sur plusieurs canaux en parall√®le."},
      {id:'q34',dim:'social',text:"Elle contourne mes cr√©neaux ou contacte mon entourage.",critical:true},
      {id:'q35',dim:'social',text:"Elle tente d'isoler mes autres relations de soutien.",critical:true},
      {id:'q36',dim:'social',text:"Je cache la situation par honte ou peur du jugement."},

      {id:'q37',dim:'reversibilite',text:"Mon √©nergie remonte quand je r√©duis le contact.",reverse:true},
      {id:'q38',dim:'reversibilite',text:"Des r√®gles claires am√©liorent la relation.",reverse:true},
      {id:'q39',dim:'reversibilite',text:"Elle reconna√Æt ses exc√®s et modifie son comportement.",reverse:true},
      {id:'q40',dim:'reversibilite',text:"Les am√©liorations tiennent rarement plus de quelques semaines."}
    ];

    const BANDS = [
      {min:0,max:35,level:"Relation Fonctionnelle",color:"#10b981",text:"Pas de pattern toxique majeur. Ajustements ponctuels possibles."},
      {min:36,max:70,level:"Fatigue Mod√©r√©e",color:"#f59e0b",text:"√âpuisement notable. Limites plus claires recommand√©es. Consulter si r√©sistance durable."},
      {min:71,max:110,level:"Pattern √âpuisant √âtabli",color:"#ea580c",text:"Toxicit√© significative. Bien-√™tre affect√©. R√©duire exposition + consultation psychologique recommand√©e."},
      {min:111,max:200,level:"D√©rive d'Emprise Probable",color:"#dc2626",text:"‚ö†Ô∏è Dynamique potentiellement coercitive. PRIORIT√â : protection, distance, soutien sp√©cialis√© imm√©diat."}
    ];

    // √©tat
    const state = {screen:'intro',qIdx:0,answers:{},anamnesis:{type:null,dur:null,name:'Anonyme'}};

    // initialisation
    document.addEventListener('DOMContentLoaded', () => {
      const consent = document.getElementById('consent-checkbox');
      const relType = document.getElementById('relation-type');
      const startBtn = document.getElementById('start-btn');

      function updateStart(){ startBtn.disabled = !(consent.checked && relType.value); }
      consent.addEventListener('change', updateStart);
      relType.addEventListener('change', updateStart);

      startBtn.addEventListener('click', () => {
        state.anamnesis.type = relType.value || 'Non pr√©cis√©';
        state.anamnesis.dur = document.getElementById('relation-duration').value || 'Non pr√©cis√©';
        state.anamnesis.name = (document.getElementById('user-name').value || 'Anonyme').trim() || 'Anonyme';
        state.qIdx = 0;
        state.answers = {};
        showScreen('test');
        renderQ();
      });

      document.getElementById('pdf-btn').addEventListener('click', genPDF);
      document.getElementById('email-btn').addEventListener('click', sendEmail);
      document.getElementById('json-btn').addEventListener('click', dlJSON);
      document.getElementById('reset-btn').addEventListener('click', () => {
        if (confirm("Recommencer ? R√©ponses perdues.")) {
          state.qIdx = 0; state.answers = {}; showScreen('intro');
        }
      });
    });

    // navigation d'√©crans
    function showScreen(s){
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      const el = document.getElementById(s + '-screen');
      if (el) el.classList.add('active');
      state.screen = s;
      window.scrollTo(0,0);
    }

    // rendu de la question courante
    function renderQ(){
      const q = QUESTIONS[state.qIdx];
      if (!q) return;
      const dim = DIMENSIONS.find(d => d.k === q.dim) || {l:'', c:'#666'};
      const prog = Math.round(((state.qIdx + 1) / QUESTIONS.length) * 100);
      document.getElementById('progress-text').textContent = `Question ${state.qIdx + 1} / ${QUESTIONS.length}`;
      document.getElementById('progress-fill').style.width = `${prog}%`;

      // construire les options (√©viter injection)
      const container = document.createElement('div');
      container.className = 'question-card';

      const tag = document.createElement('div');
      tag.style.cssText = `background:${dim.c}15;color:${dim.c};padding:4px 12px;border-radius:999px;font-size:14px;font-weight:600;display:inline-block;margin-bottom:16px;`;
      tag.textContent = dim.l;
      container.appendChild(tag);

      const qText = document.createElement('div');
      qText.className = 'question-text';
      qText.innerHTML = q.text + (q.critical ? ' <span style="color:#dc2626">‚ö†</span>' : '');
      container.appendChild(qText);

      const optionsWrap = document.createElement('div');
      SCALE.forEach(opt => {
        const b = document.createElement('div');
        b.className = 'answer-option';
        if (state.answers[q.id] === opt.v) b.classList.add('selected');
        b.tabIndex = 0;
        // contenu
        const inner = document.createElement('div');
        const label = document.createElement('div');
        label.className = 'option-label';
        label.textContent = opt.l;
        const sub = document.createElement('div');
        sub.className = 'option-sublabel';
        sub.textContent = opt.s;
        inner.appendChild(label);
        inner.appendChild(sub);
        b.appendChild(inner);

        // interaction
        b.addEventListener('click', () => selectAnswer(opt.v));
        b.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectAnswer(opt.v); } });

        optionsWrap.appendChild(b);
      });
      container.appendChild(optionsWrap);

      // navigation
      const nav = document.createElement('div');
      nav.className = 'question-nav';

      const prev = document.createElement('button');
      prev.className = 'btn btn-secondary';
      prev.textContent = '‚Üê Pr√©c√©dent';
      prev.style.visibility = state.qIdx === 0 ? 'hidden' : 'visible';
      prev.addEventListener('click', prevQ);

      const next = document.createElement('button');
      next.className = 'btn btn-primary';
      next.textContent = state.qIdx === QUESTIONS.length - 1 ? 'Voir R√©sultats' : 'Suivant ‚Üí';
      // activer seulement si r√©ponse fournie (m√™me 0)
      next.disabled = !(state.answers.hasOwnProperty(q.id));
      next.addEventListener('click', nextQ);

      nav.appendChild(prev);
      nav.appendChild(next);

      // injecter dans DOM
      const qc = document.getElementById('question-container');
      qc.innerHTML = '';
      qc.appendChild(container);
      qc.appendChild(nav);
    }

    // s√©lection d'une r√©ponse
    function selectAnswer(v){
      const qid = QUESTIONS[state.qIdx].id;
      state.answers[qid] = v;
      // re-render pour montrer la s√©lection et activer suivant
      renderQ();
      // petit d√©lai pour laisser l'animation visuelle, puis avancer si souhait√©
      setTimeout(() => {
        // avancer automatiquement sauf si on est √† la derni√®re question (l'utilisateur pourra appuyer)
        if (state.qIdx < QUESTIONS.length - 1) {
          state.qIdx++;
          renderQ();
        } else {
          showResults();
        }
      }, 300);
    }

    function nextQ(){
      if (state.qIdx < QUESTIONS.length - 1) {
        state.qIdx++;
        renderQ();
      } else {
        showResults();
      }
    }
    function prevQ(){
      if (state.qIdx > 0) {
        state.qIdx--;
        renderQ();
      }
    }

    // calcul des scores
    function calcScores(){
      const dimScores = {};
      DIMENSIONS.forEach(d => { dimScores[d.k] = { w:0, maxW:0 }; });
      let totalW = 0, maxW = 0;

      QUESTIONS.forEach(q => {
        if (!Object.prototype.hasOwnProperty.call(state.answers, q.id)) return;
        const ans = state.answers[q.id];
        const weight = q.critical ? 1.5 : 1;
        const adj = q.reverse ? (4 - ans) : ans;
        totalW += adj * weight;
        maxW += 4 * weight;
        if (!dimScores[q.dim]) dimScores[q.dim] = { w:0, maxW:0 };
        dimScores[q.dim].w += adj * weight;
        dimScores[q.dim].maxW += 4 * weight;
      });

      Object.keys(dimScores).forEach(k => {
        const d = dimScores[k];
        d.pct = d.maxW > 0 ? Math.round((d.w / d.maxW) * 100) : 0;
      });

      const riskIdx = maxW > 0 ? Math.round((totalW / maxW) * 100) : 0;
      const pct = maxW > 0 ? (totalW / maxW) * 100 : 0;
      const band = BANDS.find(b => pct >= b.min && pct <= b.max) || BANDS[0];

      return { totalW, maxW, riskIdx, dims: dimScores, band };
    }

    // affichage r√©sultats
    function showResults(){
      showScreen('results');
      const sc = calcScores();

      // cercle score
      const r = 120;
      const circ = 2 * Math.PI * r;
      const offset = circ - (sc.riskIdx / 100) * circ;
      document.getElementById('score-circle').innerHTML = `
        <svg width="280" height="280" style="transform:rotate(-90deg)">
          <circle cx="140" cy="140" r="${r}" fill="none" stroke="#F7F5EF" stroke-width="14"/>
          <circle cx="140" cy="140" r="${r}" fill="none" stroke="#C7A86D" stroke-width="14"
            stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round"
            style="transition:stroke-dashoffset 1.2s cubic-bezier(0.16,1,0.3,1)"/>
          <text x="50%" y="42%" text-anchor="middle" font-family="Fraunces" font-size="56" font-weight="700" fill="#0A0A0A" transform="rotate(90 140 140)">${sc.riskIdx}</text>
          <text x="50%" y="58%" text-anchor="middle" font-family="Inter" font-size="18" fill="#666" transform="rotate(90 140 140)">/ 100</text>
        </svg>
      `;

      // bande r√©sultat
      document.getElementById('result-band').innerHTML = `
        <div style="background:${sc.band.color}15;border:2px solid ${sc.band.color};padding:24px;border-radius:8px;margin-top:24px;">
          <div style="font-size:32px;font-weight:700;color:${sc.band.color};margin-bottom:12px;">${sc.band.level}</div>
          <div style="font-size:18px;line-height:1.7;">${sc.band.text}</div>
        </div>
      `;

      // barres par dimension
      const dimsHtml = Object.entries(sc.dims).map(([k,d]) => {
        const dim = DIMENSIONS.find(x => x.k === k) || { l:k, c:'#666' };
        return `
          <div class="dimension-bar">
            <div class="dimension-bar-header" style="display:flex;justify-content:space-between">
              <span style="font-weight:600">${dim.l}</span>
              <span style="font-weight:600;color:#C7A86D">${d.pct}%</span>
            </div>
            <div class="dimension-bar-track">
              <div class="dimension-bar-fill" style="width:${d.pct}%;background:${dim.c}"></div>
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('dimension-bars').innerHTML = dimsHtml;

      // profil contextuel
      document.getElementById('profile-summary').innerHTML = `
        <p><strong>Type:</strong> ${state.anamnesis.type}</p>
        <p><strong>Dur√©e:</strong> ${state.anamnesis.dur}</p>
        <p><strong>Participant¬∑e:</strong> ${state.anamnesis.name}</p>
      `;

      // recommandations
      let recs = [];
      if (sc.band.level === "Relation Fonctionnelle") {
        recs.push("Maintenir l'√©quilibre actuel et communiquer ouvertement.");
      } else if (sc.band.level === "Fatigue Mod√©r√©e") {
        recs.push("Clarifier vos limites par √©crit si n√©cessaire.");
        recs.push("Consulter un¬∑e psychologue si r√©sistance durable.");
      } else if (sc.band.level === "Pattern √âpuisant √âtabli") {
        recs.push("R√©duire drastiquement l'exposition.");
        recs.push("Accompagnement professionnel prioritaire.");
        recs.push("Constituer un r√©seau de soutien.");
      } else {
        recs.push("‚ö†Ô∏è PRIORIT√â S√âCURIT√â : 3919 ou 17 si danger.");
        recs.push("Mise √† distance imm√©diate.");
        recs.push("Soutien sp√©cialis√© multidisciplinaire (psy+asso+avocat).");
        recs.push("Documenter exhaustivement.");
      }
      document.getElementById('recommendations').innerHTML = recs.map(r => `<p style="margin-bottom:12px;">‚Ä¢ ${r}</p>`).join('');
    }

    // export PDF (ouvre une nouvelle fen√™tre et imprime)
    function genPDF(){
      const sc = calcScores();
      const w = window.open('', '', 'width=800,height=600');
      if (!w) return alert('Impossible d‚Äôouvrir la fen√™tre d‚Äôimpression (bloqu√©e par le navigateur).');
      w.document.write(`
        <!doctype html><html lang="fr"><head><meta charset="utf-8"><title>Rapport Relations √âpuisantes ‚Äî NO√âSIS</title>
        <style>@page{size:A4;margin:2.5cm}body{font-family:Inter,Arial,sans-serif;font-size:10pt;color:#0A0A0A}h1{text-align:center}</style></head><body>
        <h1>NO√âSIS ‚Äî Relations √âpuisantes</h1>
        <p style="text-align:center">${state.anamnesis.name} ‚Ä¢ ${new Date().toLocaleDateString('fr-FR')}</p>
        <h2>Synth√®se</h2><div style="font-size:36px;font-weight:700;color:#C7A86D;text-align:center">${sc.riskIdx}/100</div>
        <p style="text-align:center;color:${sc.band.color};font-weight:600">${sc.band.level}</p>
        <p>${sc.band.text}</p>
        <h2>Dimensions</h2><table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:6px;background:#F7F5EF">Dimension</th><th style="text-align:left;padding:6px;background:#F7F5EF">Score</th></tr></thead><tbody>
        ${Object.entries(sc.dims).map(([k,d])=>{const dim = DIMENSIONS.find(x=>x.k===k)||{l:k};return `<tr><td style="padding:6px">${dim.l}</td><td style="padding:6px">${d.pct}%</td></tr>`}).join('')}
        </tbody></table>
        <h2>Ressources</h2><ul><li>3919 ‚Äî Violences Femmes Info</li><li>119 ‚Äî All√¥ Enfance</li><li>3114 ‚Äî Pr√©vention Suicide</li></ul>
        <p style="font-size:9pt;color:#666;text-align:center;margin-top:30px">¬© ${new Date().getFullYear()} NO√âSIS ‚Äî Outil exploratoire non valid√© scientifiquement</p>
        </body></html>
      `);
      w.document.close();
      setTimeout(()=>w.print(),600);
    }

    // envoi email
    function sendEmail(){
      const sc = calcScores();
      const body = `Rapport NO√âSIS ‚Äî Relations √âpuisantes\n${state.anamnesis.name} ‚Ä¢ ${new Date().toLocaleDateString('fr-FR')}\n\nIndice: ${sc.riskIdx}/100\nNiveau: ${sc.band.level}\n\n${sc.band.text}\n\nRessources: 3919 (Violences) ‚Ä¢ 3114 (Suicide)`;
      window.location.href = `mailto:?subject=${encodeURIComponent('Rapport Relations √âpuisantes ‚Äî NO√âSIS')}&body=${encodeURIComponent(body)}`;
    }

    // export JSON
    function dlJSON(){
      const sc = calcScores();
      const data = { metadata:{test:"Relations √âpuisantes",version:"1.0",date:new Date().toISOString()}, anamnesis: state.anamnesis, scoring: sc, responses: state.answers };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `noesis-relations-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
