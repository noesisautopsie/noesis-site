<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- SEO -->
  <title>Red Flags : Grille d'√âvaluation par Phase ‚Äî Auto-test NO√âSIS</title>
  <meta name="description" content="Grille d'√©valuation clinique (50 items) des signaux d'alerte relationnels phase par phase. Identification pr√©coce des dynamiques toxiques et orientation adapt√©e.">
  
  <!-- Open Graph -->
  <meta property="og:title" content="Red Flags : √âvaluation par Phase ‚Äî NO√âSIS">
  <meta property="og:description" content="Test 50 questions pour identifier les signaux d'alerte relationnels par phase.">
  <meta property="og:type" content="website">
  
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React + ReactDOM via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone pour JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* Styles d'impression PDF optimis√©s A4 */
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      
      body { 
        background: white !important;
        margin: 0;
        padding: 0;
      }
      
      @page {
        size: A4;
        margin: 12mm 15mm;
      }
      
      .print-container {
        max-width: 100%;
        padding: 0 !important;
        margin: 0 !important;
      }
      
      .print-section {
        padding: 8px 0 !important;
        margin-bottom: 12px !important;
      }
      
      .print-header {
        font-size: 18px !important;
        margin-bottom: 8px !important;
        padding-bottom: 4px !important;
        border-bottom: 2px solid #334155;
      }
      
      .print-subheader {
        font-size: 14px !important;
        margin: 8px 0 4px 0 !important;
      }
      
      .print-text {
        font-size: 11px !important;
        line-height: 1.4 !important;
        margin: 2px 0 !important;
      }
      
      .print-question {
        font-size: 11px !important;
        padding: 3px 0 !important;
        page-break-inside: avoid;
      }
      
      .print-phase-section {
        page-break-inside: avoid;
        margin-bottom: 10px !important;
      }
      
      .print-score-box {
        padding: 6px !important;
        margin: 4px 0 !important;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
      }
      
      .print-reco {
        font-size: 11px !important;
        padding: 2px 0 2px 16px !important;
        margin: 2px 0 !important;
      }
    }
    
    .print-only {
      display: none;
    }
  </style>
</head>
<body class="m-0 p-0">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useCallback } = React;

    // ============================================================
    // CONFIGURATION
    // ============================================================

    const PHASES = [
      { 
        key: "p1", 
        label: "Phase 1 ‚Äî Id√©alisation / S√©duction", 
        color: "amber",
        description: "Intensit√© excessive, promesses rapides, fusion √©motionnelle"
      },
      { 
        key: "p2", 
        label: "Phase 2 ‚Äî Investissement √©motionnel", 
        color: "rose",
        description: "Dette affective, micro-critiques, r√©ciprocit√© asym√©trique"
      },
      { 
        key: "p3", 
        label: "Phase 3 ‚Äî D√©stabilisation subtile", 
        color: "sky",
        description: "Micro-critiques, doute de soi, contr√¥le masqu√©"
      },
      { 
        key: "p4", 
        label: "Phase 4 ‚Äî Confusion & Contr√¥le", 
        color: "violet",
        description: "Isolement, gaslighting, chantage affectif"
      },
      { 
        key: "p5", 
        label: "Phase 5 ‚Äî √ârosion ou Reconstruction", 
        color: "emerald",
        description: "Rupture/retour, trauma bonding, reconstruction"
      }
    ];

    const CHOICES = [
      { value: 0, label: "Jamais", anchor: "0 fois / 12 mois" },
      { value: 1, label: "Parfois", anchor: "1-3√ó / trimestre" },
      { value: 2, label: "Souvent", anchor: "1-3√ó / mois" },
      { value: 3, label: "Tr√®s souvent", anchor: "Hebdomadaire ou +" }
    ];

    const QUESTIONS = [
      // Phase 1 - Id√©alisation / S√©duction (10)
      { id: "Q1", dim: "p1", text: "D√©clarations tr√®s rapides de sentiments 'exceptionnels' d√®s le d√©but." },
      { id: "Q2", dim: "p1", text: "Promesses d'avenir grandioses sans base concr√®te (projets pr√©cipit√©s)." },
      { id: "Q3", dim: "p1", text: "Rythme d'√©changes tr√®s intense, difficile √† ralentir sans culpabilit√©." },
      { id: "Q4", dim: "p1", text: "Compliments excessifs suivis d'attentes implicites en retour." },
      { id: "Q5", dim: "p1", text: "Recherche d'exclusivit√© tr√®s t√¥t (jalousie, acc√®s prioritaire)." },
      { id: "Q6", dim: "p1", text: "Il/elle s'adapte 'parfaitement' √† tout ce que j'exprime (effet miroir)." },
      { id: "Q7", dim: "p1", text: "Pression pour partager vite informations intimes ou vuln√©rables." },
      { id: "Q8", dim: "p1", text: "Id√©alisation de soi avec d√©nigrement syst√©matique de ses ex." },
      { id: "Q9", dim: "p1", text: "Cadeaux ou gestes grandioses cr√©ant une dette implicite." },
      { id: "Q10", dim: "p1", text: "Inconfort interne mais difficult√© √† poser un tempo plus lent." },
      
      // Phase 2 - Investissement √©motionnel (10)
      { id: "Q11", dim: "p2", text: "Je partage des vuln√©rabilit√©s, l'accueil est chaud mais suivi d'attentes." },
      { id: "Q12", dim: "p2", text: "Mes limites sont entendues verbalement mais souvent contourn√©es." },
      { id: "Q13", dim: "p2", text: "Je me surprends √† justifier ses comportements aupr√®s de mes proches." },
      { id: "Q14", dim: "p2", text: "Je priorise la relation au d√©triment d'autres domaines importants." },
      { id: "Q15", dim: "p2", text: "Je modifie mes routines ou valeurs pour √©viter ses r√©actions n√©gatives." },
      { id: "Q16", dim: "p2", text: "Je ressens une dette affective quand je ne suis pas disponible." },
      { id: "Q17", dim: "p2", text: "Il/elle me confie des douleurs lourdes que je dois 'r√©parer'." },
      { id: "Q18", dim: "p2", text: "Des micro-critiques apparaissent sous couvert d'humour ou de conseil." },
      { id: "Q19", dim: "p2", text: "Il/elle collecte des informations sensibles sans r√©ciprocit√© r√©elle." },
      { id: "Q20", dim: "p2", text: "Des excuses existent, mais les comportements changent peu." },
      
      // Phase 3 - D√©stabilisation subtile (10)
      { id: "Q21", dim: "p3", text: "Je doute plus de moi depuis cette relation (m√©moire, choix, valeur)." },
      { id: "Q22", dim: "p3", text: "Il/elle minimise mes ressentis ('tu exag√®res', 'tu es sensible')." },
      { id: "Q23", dim: "p3", text: "Je marche sur des ≈ìufs pour √©viter reproches ou jalousie." },
      { id: "Q24", dim: "p3", text: "R√©cits contradictoires ou changement de version selon l'int√©r√™t." },
      { id: "Q25", dim: "p3", text: "Silence punitif ou retrait affectif si je pose des limites." },
      { id: "Q26", dim: "p3", text: "Comparaisons avec d'autres pour me rendre ins√©cure." },
      { id: "Q27", dim: "p3", text: "Je me sens redevable d'actes que je n'ai pas choisis." },
      { id: "Q28", dim: "p3", text: "Je cache des aspects de ma vie pour √©viter conflits ou col√®res." },
      { id: "Q29", dim: "p3", text: "Je fais des efforts disproportionn√©s pour garder la paix." },
      { id: "Q30", dim: "p3", text: "Mes 'non' sont n√©goci√©s jusqu'√† ce que je c√®de par √©puisement." },
      
      // Phase 4 - Confusion & Contr√¥le (10)
      { id: "Q31", dim: "p4", text: "Je re√ßois des consignes contradictoires ('sois spontan√©¬∑e mais toujours dispo')." },
      { id: "Q32", dim: "p4", text: "Isolement progressif de mon entourage (critiques, jalousie, sabotage)." },
      { id: "Q33", dim: "p4", text: "Surveillance des horaires, r√©seaux sociaux, localisation, amis." },
      { id: "Q34", dim: "p4", text: "Menaces voil√©es (rupture, punition, col√®re) si je refuse quelque chose." },
      { id: "Q35", dim: "p4", text: "Crises ou drames cr√©√©s syst√©matiquement apr√®s mes demandes l√©gitimes." },
      { id: "Q36", dim: "p4", text: "R√©√©criture des faits pour me faire douter de ma perception (gaslighting)." },
      { id: "Q37", dim: "p4", text: "Pressions sexuelles, financi√®res ou morales pour obtenir ce qu'il/elle veut." },
      { id: "Q38", dim: "p4", text: "Je suis test√©¬∑e (jalousie, loyaut√©) avec des pi√®ges √©motionnels." },
      { id: "Q39", dim: "p4", text: "Mes succ√®s sont minimis√©s ou appropri√©s par l'autre." },
      { id: "Q40", dim: "p4", text: "Je ressens peur, confusion ou √©puisement apr√®s nos √©changes." },
      
      // Phase 5 - √ârosion ou Reconstruction (10)
      { id: "Q41", dim: "p5", text: "Allers-retours fr√©quents rupture/retour ('montagnes russes' affectives)." },
      { id: "Q42", dim: "p5", text: "Je tol√®re des comportements que j'aurais refus√©s auparavant." },
      { id: "Q43", dim: "p5", text: "Je perds contact avec mes besoins et valeurs prioritaires." },
      { id: "Q44", dim: "p5", text: "Je m'excuse souvent pour garder la relation malgr√© l'injustice." },
      { id: "Q45", dim: "p5", text: "Ma sant√© (sommeil, stress, concentration) se d√©grade visiblement." },
      { id: "Q46", dim: "p5", text: "Je pr√©pare une sortie mais je reste par espoir ou peur." },
      { id: "Q47", dim: "p5", text: "Je sollicite peu d'aide externe par honte ou crainte du jugement." },
      { id: "Q48", dim: "p5", text: "Je reconstruis des limites mais retombe apr√®s ses promesses." },
      { id: "Q49", dim: "p5", text: "Je collecte des preuves ou captures d'√©changes pour clarifier la r√©alit√©." },
      { id: "Q50", dim: "p5", text: "Je planifie des √©tapes concr√®tes pour me prot√©ger ou me r√©parer." }
    ];

    // ============================================================
    // FONCTIONS CALCUL & INTERPR√âTATION
    // ============================================================

    function getInterpretation(total) {
      if (total <= 45) {
        return {
          level: "√âquilibre relationnel",
          color: "green",
          severity: "none",
          text: "Peu de signaux d'alerte identifi√©s. La dynamique relationnelle semble globalement saine avec respect mutuel des limites et r√©ciprocit√© affective.",
          recommendations: [
            "Continuer √† cultiver une communication claire et respectueuse.",
            "Maintenir des espaces d'autonomie et des relations ext√©rieures √©quilibr√©es.",
            "Rester attentif¬∑ve √† l'√©volution de la dynamique relationnelle."
          ]
        };
      } else if (total <= 90) {
        return {
          level: "Red flags mod√©r√©s",
          color: "yellow",
          severity: "low",
          text: "Des points de vigilance apparaissent. Certains comportements m√©ritent attention et ajustement, particuli√®rement si concentration sur phases 3-4.",
          recommendations: [
            "Ralentir le rythme relationnel et cr√©er des espaces de recul.",
            "Nommer clairement vos limites et observer comment elles sont accueillies.",
            "Solliciter un regard ext√©rieur (ami¬∑e de confiance, th√©rapeute du lien).",
            "Documenter les situations probl√©matiques pour clarifier votre perception."
          ]
        };
      } else if (total <= 120) {
        return {
          level: "Red flags significatifs",
          color: "orange",
          severity: "moderate",
          text: "Pattern relationnel potentiellement toxique identifi√©. La dynamique pr√©sente plusieurs marqueurs d'emprise ou de contr√¥le coercitif n√©cessitant s√©curisation.",
          recommendations: [
            "Priorit√© : s√©curisation √©motionnelle et physique (plan de protection).",
            "Consultation sp√©cialis√©e en psychologie du trauma relationnel.",
            "Reconstitution d'un r√©seau de soutien externe si isolement.",
            "Pr√©paration d'une strat√©gie de sortie progressive si n√©cessaire.",
            "Documentation syst√©matique des situations probl√©matiques."
          ]
        };
      } else {
        return {
          level: "Red flags s√©v√®res",
          color: "red",
          severity: "critical",
          text: "Emprise relationnelle ou trauma bonding probable. La situation pr√©sente des marqueurs graves de violence psychologique n√©cessitant protection imm√©diate.",
          recommendations: [
            "URGENCE : S√©curit√© physique et psychique prioritaire.",
            "Contacter ressources sp√©cialis√©es (3919, associations d'aide aux victimes).",
            "Consultation psycho-traumatique sp√©cialis√©e en sortie d'emprise.",
            "Ne pas rester seul¬∑e : activer r√©seau familial/amical de confiance.",
            "√âlaboration d'un plan de sortie s√©curis√© avec accompagnement.",
            "Conservation de preuves (messages, t√©moignages) si d√©marches futures."
          ]
        };
      }
    }

    // ============================================================
    // COMPOSANT PRINCIPAL
    // ============================================================

    function RedFlagsTest() {
      const [page, setPage] = useState("intro");
      const [currentQ, setCurrentQ] = useState(0);
      const [answers, setAnswers] = useState({});
      const [email, setEmail] = useState("");

      // SUPPRESSION TOTALE localStorage ‚Äî Test toujours vierge

      const allAnswered = Object.keys(answers).length === QUESTIONS.length;

      const handleAnswer = useCallback((qId, value) => {
        setAnswers(prev => ({ ...prev, [qId]: value }));
        
        if (currentQ < QUESTIONS.length - 1) {
          setTimeout(() => setCurrentQ(c => c + 1), 150);
        }
      }, [currentQ]);

      const goToResults = useCallback(() => {
        if (!allAnswered) {
          alert(`Il reste ${QUESTIONS.length - Object.keys(answers).length} question(s) sans r√©ponse.`);
          return;
        }
        setPage("results");
      }, [allAnswered, answers]);

      const reset = useCallback(() => {
        setAnswers({});
        setCurrentQ(0);
        setPage("intro");
        setEmail("");
      }, []);

      const phaseScores = useMemo(() => {
        const scores = {};
        PHASES.forEach(phase => {
          const qs = QUESTIONS.filter(q => q.dim === phase.key);
          const total = qs.reduce((sum, q) => sum + (answers[q.id] || 0), 0);
          scores[phase.key] = total;
        });
        return scores;
      }, [answers]);

      const totalScore = useMemo(() => {
        return Object.values(phaseScores).reduce((sum, val) => sum + val, 0);
      }, [phaseScores]);

      const indices = useMemo(() => {
        const CAI = phaseScores.p3 + phaseScores.p4;
        const RRI = 30 - phaseScores.p5;
        return { CAI, RRI };
      }, [phaseScores]);

      const resultBand = useMemo(() => getInterpretation(totalScore), [totalScore]);

      const handlePDF = useCallback(() => {
        window.print();
      }, []);

      const handleDownloadJSON = useCallback(() => {
        const data = {
          test: "Red Flags ‚Äî √âvaluation par Phase",
          date: new Date().toISOString(),
          totalScore,
          phaseScores,
          indices,
          interpretation: resultBand.level,
          answers: QUESTIONS.map(q => ({
            id: q.id,
            phase: q.dim,
            question: q.text,
            answer: CHOICES.find(c => c.value === answers[q.id])?.label || "Non r√©pondu"
          }))
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `noesis-redflags-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }, [totalScore, phaseScores, indices, resultBand, answers]);

      const handleEmail = useCallback(() => {
        if (!email) return;
        const subject = encodeURIComponent("R√©sultats Auto-test Red Flags");
        const body = encodeURIComponent(
          `Bonjour,\n\nVoici mes r√©sultats au test Red Flags NO√âSIS :\n\n` +
          `Score total : ${totalScore}/150\n` +
          `Profil : ${resultBand.level}\n` +
          `CAI : ${indices.CAI}/60\n` +
          `RRI : ${indices.RRI}/30\n\n` +
          `Pour consulter le d√©tail complet, merci de t√©l√©charger le PDF ou JSON depuis le site.`
        );
        window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
      }, [email, totalScore, resultBand, indices]);

      const progress = useMemo(() => Math.round((currentQ / QUESTIONS.length) * 100), [currentQ]);

      // ============================================================
      // PAGE INTRO
      // ============================================================

      if (page === "intro") {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 via-rose-50 to-amber-50 p-4 md:p-8">
            <div className="max-w-3xl mx-auto">
              <div className="text-center mb-8">
                <div className="inline-block p-4 bg-rose-100 rounded-2xl mb-4">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-rose-600">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                </div>
                <h1 className="text-4xl md:text-5xl font-black text-slate-900 mb-3">
                  Red Flags : Grille d'√âvaluation par Phase
                </h1>
                <p className="text-lg text-slate-600 font-medium">
                  Outil de rep√©rage des signaux d'alerte relationnels
                </p>
              </div>

              <div className="bg-white rounded-2xl shadow-2xl p-6 md:p-8 mb-6">
                <div className="bg-amber-50 border-l-4 border-amber-500 p-4 mb-6 rounded-r-lg">
                  <div className="flex gap-3">
                    <span className="text-2xl flex-shrink-0">‚ö†Ô∏è</span>
                    <div className="text-sm text-amber-900">
                      <p className="font-bold mb-1">Avertissement m√©thodologique</p>
                      <p className="leading-relaxed">
                        Cet outil identifie des signaux d'alerte (red flags) √† diff√©rentes phases d'√©volution relationnelle. 
                        Il ne constitue <strong>pas un diagnostic clinique</strong>. Les r√©sultats servent de base de r√©flexion 
                        et d'orientation. En cas de souffrance, peur ou confusion significative, consultez un¬∑e professionnel¬∑le sp√©cialis√©¬∑e.
                      </p>
                    </div>
                  </div>
                </div>

                <div className="mb-8">
                  <div className="flex items-center gap-2 mb-4">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-slate-700">
                      <circle cx="11" cy="11" r="8"/>
                      <path d="m21 21-4.35-4.35"/>
                      <circle cx="11" cy="11" r="3"/>
                    </svg>
                    <h2 className="text-xl font-bold text-slate-900">M√©thodologie</h2>
                  </div>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
                    <div className="bg-amber-50 text-amber-700 px-3 py-2 rounded-lg text-center text-sm font-semibold">
                      Id√©alisation
                    </div>
                    <div className="bg-rose-50 text-rose-700 px-3 py-2 rounded-lg text-center text-sm font-semibold">
                      Investissement
                    </div>
                    <div className="bg-sky-50 text-sky-700 px-3 py-2 rounded-lg text-center text-sm font-semibold">
                      D√©stabilisation
                    </div>
                    <div className="bg-violet-50 text-violet-700 px-3 py-2 rounded-lg text-center text-sm font-semibold">
                      Contr√¥le
                    </div>
                    <div className="bg-emerald-50 text-emerald-700 px-3 py-2 rounded-lg text-center text-sm font-semibold col-span-2 md:col-span-1">
                      Reconstruction
                    </div>
                  </div>

                  <div className="prose prose-sm text-slate-700 space-y-3">
                    <p className="leading-relaxed">
                      Grille structur√©e selon <strong>5 phases d'√©volution relationnelle</strong>, bas√©e sur la recherche en 
                      psychologie du trauma relationnel (Judith Herman, Pat Carnes), clinique de l'emprise 
                      (Marie-France Hirigoyen) et th√©orie de l'attachement (Bowlby, Ainsworth). 
                      √âvaluation sur les <strong>12 derniers mois</strong>.
                    </p>
                  </div>
                </div>

                <div className="grid md:grid-cols-3 gap-4 mb-8">
                  <div className="bg-slate-50 p-4 rounded-xl text-center">
                    <div className="flex justify-center mb-2">
                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-rose-600">
                        <circle cx="12" cy="13" r="9"/>
                        <polyline points="12 7 12 13 15 15"/>
                        <path d="M10 2h4"/>
                      </svg>
                    </div>
                    <div className="text-2xl font-bold text-slate-900">18-20 min</div>
                    <div className="text-sm text-slate-600">Dur√©e estim√©e</div>
                  </div>
                  <div className="bg-slate-50 p-4 rounded-xl text-center">
                    <div className="flex justify-center mb-2">
                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-rose-600">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                      </svg>
                    </div>
                    <div className="text-2xl font-bold text-slate-900">50 questions</div>
                    <div className="text-sm text-slate-600">Questionnaire complet</div>
                  </div>
                  <div className="bg-slate-50 p-4 rounded-xl text-center">
                    <div className="flex justify-center mb-2">
                      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-rose-600">
                        <path d="M3 3v18h18"/>
                        <path d="M18 9l-5 5-4-4-4 4"/>
                        <circle cx="18" cy="9" r="2" fill="currentColor"/>
                        <circle cx="13" cy="14" r="2" fill="currentColor"/>
                        <circle cx="9" cy="10" r="2" fill="currentColor"/>
                        <circle cx="5" cy="14" r="2" fill="currentColor"/>
                      </svg>
                    </div>
                    <div className="text-2xl font-bold text-slate-900">5 phases</div>
                    <div className="text-sm text-slate-600">Analyse multi-phases</div>
                  </div>
                </div>

                <button
                  onClick={() => setPage("test")}
                  className="w-full bg-gradient-to-r from-rose-600 to-amber-600 hover:from-rose-700 hover:to-amber-700 text-white text-lg font-bold py-4 px-6 rounded-xl transition-all shadow-lg hover:shadow-xl"
                >
                  Commencer le test ‚Üí
                </button>
              </div>

              <div className="text-center text-xs text-slate-500 space-y-1">
                <p className="font-semibold">NO√âSIS ‚Äî Red Flags : √âvaluation par Phase v1.0 ‚Ä¢ ¬© 2025</p>
                <p>Confidentialit√© : aucune donn√©e collect√©e sans action explicite (RGPD)</p>
              </div>
            </div>
          </div>
        );
      }

      // ============================================================
      // PAGE TEST
      // ============================================================

      if (page === "test") {
        const q = QUESTIONS[currentQ];
        const phaseInfo = PHASES.find(p => p.key === q.dim);
        const colorMap = {
          amber: { bg: "bg-amber-50", border: "border-amber-300", text: "text-amber-700", badge: "bg-amber-100 text-amber-700" },
          rose: { bg: "bg-rose-50", border: "border-rose-300", text: "text-rose-700", badge: "bg-rose-100 text-rose-700" },
          sky: { bg: "bg-sky-50", border: "border-sky-300", text: "text-sky-700", badge: "bg-sky-100 text-sky-700" },
          violet: { bg: "bg-violet-50", border: "border-violet-300", text: "text-violet-700", badge: "bg-violet-100 text-violet-700" },
          emerald: { bg: "bg-emerald-50", border: "border-emerald-300", text: "text-emerald-700", badge: "bg-emerald-100 text-emerald-700" },
        };
        const colors = colorMap[phaseInfo.color];

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 via-rose-50 to-amber-50 p-4 md:p-8">
            <div className="max-w-3xl mx-auto">
              
              <div className="mb-6">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-sm font-medium text-slate-600">
                    Question {currentQ + 1} / {QUESTIONS.length}
                  </span>
                  <span className="text-sm font-medium text-slate-600">
                    {progress}%
                  </span>
                </div>
                <div className="w-full bg-slate-200 rounded-full h-2">
                  <div
                    className="bg-gradient-to-r from-rose-600 to-amber-600 h-2 rounded-full transition-all duration-300"
                    style={{ width: `${progress}%` }}
                  ></div>
                </div>
              </div>

              <div className={`${colors.bg} border-2 ${colors.border} rounded-2xl p-6 md:p-8 mb-6`}>
                <div className={`inline-block px-3 py-1 rounded-full text-xs font-bold mb-4 ${colors.badge}`}>
                  {phaseInfo.label}
                </div>
                
                <div className="flex items-start gap-4 mb-6">
                  <div className={`flex-shrink-0 w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center font-bold`}>
                    {currentQ + 1}
                  </div>
                  <p className="text-lg md:text-xl text-slate-900 leading-relaxed font-medium">
                    {q.text}
                  </p>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  {CHOICES.map(choice => {
                    const selected = answers[q.id] === choice.value;
                    return (
                      <button
                        key={choice.value}
                        onClick={() => handleAnswer(q.id, choice.value)}
                        className={`
                          p-4 rounded-xl border-2 transition-all font-medium
                          ${selected 
                            ? 'bg-slate-900 border-slate-900 text-white shadow-lg scale-105' 
                            : 'bg-white border-slate-200 text-slate-700 hover:border-slate-400 hover:shadow'
                          }
                        `}
                      >
                        <div className="font-bold text-sm mb-1">{choice.label}</div>
                        <div className="text-xs opacity-75">{choice.anchor}</div>
                      </button>
                    );
                  })}
                </div>
              </div>

              <div className="flex justify-between items-center gap-4">
                <button
                  onClick={() => setCurrentQ(c => c - 1)}
                  disabled={currentQ === 0}
                  className="px-6 py-3 rounded-xl bg-white border-2 border-slate-300 text-slate-700 font-semibold hover:bg-slate-50 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
                >
                  ‚Üê Pr√©c√©dent
                </button>
                <button
                  onClick={() => {
                    if (currentQ === QUESTIONS.length - 1) {
                      goToResults();
                    } else {
                      setCurrentQ(c => c + 1);
                    }
                  }}
                  className="px-6 py-3 rounded-xl bg-gradient-to-r from-rose-600 to-amber-600 hover:from-rose-700 hover:to-amber-700 text-white font-semibold transition-all shadow-lg"
                >
                  {currentQ === QUESTIONS.length - 1 ? 'Voir r√©sultats ‚Üí' : 'Suivant ‚Üí'}
                </button>
              </div>
            </div>
          </div>
        );
      }

      // ============================================================
      // PAGE R√âSULTATS
      // ============================================================

      if (page === "results") {
        const badgeColorMap = {
          green: "bg-green-100 text-green-800 border-green-300",
          yellow: "bg-yellow-100 text-yellow-800 border-yellow-300",
          orange: "bg-orange-100 text-orange-800 border-orange-300",
          red: "bg-red-100 text-red-800 border-red-300"
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 via-rose-50 to-amber-50 p-4 md:p-8">
            <div className="max-w-5xl mx-auto">
              
              {/* SECTION VISIBLE √Ä L'√âCRAN */}
              <div className="no-print space-y-6">
                <div className="text-center mb-8">
                  <div className="inline-block p-4 bg-rose-100 rounded-2xl mb-4">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-rose-600">
                      <path d="M3 3v18h18"/>
                      <path d="M18 9l-5 5-4-4-4 4"/>
                      <circle cx="18" cy="9" r="2" fill="currentColor"/>
                      <circle cx="13" cy="14" r="2" fill="currentColor"/>
                      <circle cx="9" cy="10" r="2" fill="currentColor"/>
                      <circle cx="5" cy="14" r="2" fill="currentColor"/>
                    </svg>
                  </div>
                  <h1 className="text-4xl md:text-5xl font-black text-slate-900 mb-3">
                    Votre Profil Red Flags
                  </h1>
                  <p className="text-lg text-slate-600 font-medium">
                    Grille d'√©valuation par phase
                  </p>
                </div>

                <div className="bg-white rounded-2xl shadow-2xl p-6 md:p-8">
                  <div className="text-center mb-8">
                    <div className="text-7xl md:text-8xl font-black text-slate-900 mb-3">
                      {totalScore}
                      <span className="text-3xl md:text-4xl text-slate-500 ml-2">/150</span>
                    </div>
                    <div className={`inline-block px-6 py-2 rounded-full text-xl font-bold border-2 ${badgeColorMap[resultBand.color]} mb-4`}>
                      {resultBand.level}
                    </div>
                    <p className="text-slate-700 leading-relaxed max-w-2xl mx-auto">
                      {resultBand.text}
                    </p>
                  </div>

                  <div className="grid md:grid-cols-2 gap-4 mb-8">
                    <div className="bg-slate-50 p-4 rounded-xl text-center">
                      <div className="text-xs text-slate-600 mb-1">CAI ‚Äî Confusion Affective Indice</div>
                      <div className="text-3xl font-bold text-slate-900">{indices.CAI}/60</div>
                      <div className="text-xs text-slate-600 mt-1">Phases 3 + 4 combin√©es</div>
                    </div>
                    <div className="bg-slate-50 p-4 rounded-xl text-center">
                      <div className="text-xs text-slate-600 mb-1">RRI ‚Äî R√©silience Relationnelle Indice</div>
                      <div className="text-3xl font-bold text-slate-900">{indices.RRI}/30</div>
                      <div className="text-xs text-slate-600 mt-1">Capacit√© de reconstruction</div>
                    </div>
                  </div>

                  <div className="space-y-4 mb-8">
                    <h2 className="text-2xl font-bold text-slate-900">Scores par phase</h2>
                    {PHASES.map(phase => {
                      const score = phaseScores[phase.key];
                      const max = 30;
                      const percentage = Math.round((score / max) * 100);
                      
                      const colorMap = {
                        amber: { bg: "bg-amber-50", bar: "bg-amber-500", text: "text-amber-700" },
                        rose: { bg: "bg-rose-50", bar: "bg-rose-500", text: "text-rose-700" },
                        sky: { bg: "bg-sky-50", bar: "bg-sky-500", text: "text-sky-700" },
                        violet: { bg: "bg-violet-50", bar: "bg-violet-500", text: "text-violet-700" },
                        emerald: { bg: "bg-emerald-50", bar: "bg-emerald-500", text: "text-emerald-700" },
                      };
                      const colors = colorMap[phase.color];
                      
                      return (
                        <div key={phase.key} className={`${colors.bg} p-5 rounded-xl`}>
                          <div className="flex justify-between items-center mb-3">
                            <span className={`font-bold ${colors.text}`}>{phase.label}</span>
                            <span className="text-slate-700 font-bold">{score}/{max}</span>
                          </div>
                          <div className="w-full bg-white rounded-full h-3 overflow-hidden mb-2">
                            <div 
                              className={`${colors.bar} h-full transition-all duration-500 rounded-full`}
                              style={{ width: `${percentage}%` }}
                            />
                          </div>
                          <p className="text-xs text-slate-600">{phase.description}</p>
                        </div>
                      );
                    })}
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  <div className="bg-white rounded-2xl shadow-xl p-6">
                    <h2 className="text-2xl font-bold text-slate-900 mb-4">Recommandations</h2>
                    <ul className="space-y-3">
                      {resultBand.recommendations.map((rec, idx) => (
                        <li key={idx} className="flex gap-3 text-sm text-slate-700">
                          <span className="flex-shrink-0 w-6 h-6 rounded-full bg-rose-100 text-rose-600 font-bold text-xs flex items-center justify-center">
                            {idx + 1}
                          </span>
                          <span>{rec}</span>
                        </li>
                      ))}
                    </ul>

                    <div className="mt-6 pt-6 border-t-2 border-slate-100">
                      <h3 className="font-bold text-slate-900 mb-3">Ressources d'aide (France)</h3>
                      <ul className="space-y-2 text-sm text-slate-700">
                        <li>
                          <span className="font-medium">3919</span> ‚Äî Violences Femmes Info (24h/24)
                        </li>
                        <li>
                          <span className="font-medium">116 006</span> ‚Äî France Victimes (√©coute)
                        </li>
                        <li>
                          <span className="font-medium">3114</span> ‚Äî Pr√©vention suicide
                        </li>
                      </ul>
                    </div>
                  </div>

                  <div className="bg-white rounded-2xl shadow-xl p-6">
                    <h2 className="text-2xl font-bold text-slate-900 mb-4">Exporter les r√©sultats</h2>
                    
                    <div className="space-y-3">
                      <button
                        onClick={handlePDF}
                        className="w-full bg-slate-900 hover:bg-slate-800 text-white font-semibold py-3 px-4 rounded-xl transition-all shadow-lg"
                      >
                        üìÑ T√©l√©charger en PDF
                      </button>

                      <button
                        onClick={handleDownloadJSON}
                        className="w-full bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-4 rounded-xl transition-all"
                      >
                        üíæ Exporter en JSON
                      </button>

                      <div className="pt-4 border-t-2 border-slate-100">
                        <label className="block text-sm font-medium text-slate-700 mb-2">
                          Envoyer par email
                        </label>
                        <div className="flex gap-2">
                          <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            placeholder="email@exemple.com"
                            className="flex-1 rounded-lg border-2 border-slate-300 px-3 py-2 text-sm focus:border-rose-500 focus:outline-none"
                          />
                          <button
                            onClick={handleEmail}
                            disabled={!email}
                            className="bg-rose-600 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-semibold px-4 py-2 rounded-lg hover:bg-rose-700 transition-all"
                          >
                            ‚úâÔ∏è
                          </button>
                        </div>
                      </div>

                      <button
                        onClick={reset}
                        className="w-full mt-4 text-slate-600 hover:text-slate-900 font-medium text-sm underline"
                      >
                        Refaire le test
                      </button>
                    </div>
                  </div>
                </div>

                <div className="text-center text-xs text-slate-500 space-y-1">
                  <p className="font-semibold">NO√âSIS ‚Äî Red Flags : √âvaluation par Phase v1.0 ‚Ä¢ ¬© 2025</p>
                  <p>Outil de rep√©rage relationnel. Ne remplace pas un avis professionnel.</p>
                  <p>Confidentialit√© : aucune donn√©e collect√©e sans action explicite (RGPD)</p>
                </div>
              </div>

              {/* SECTION IMPRIMABLE PDF (cach√©e √† l'√©cran) */}
              <div className="print-only print-container">
                <div className="print-section">
                  <h1 className="print-header">R√©sultats ‚Äî Red Flags : √âvaluation par Phase</h1>
                  <p className="print-text">Date : {new Date().toLocaleDateString('fr-FR')}</p>
                  <p className="print-text">Score total : <strong>{totalScore}/150</strong></p>
                  <p className="print-text">Profil : <strong>{resultBand.level}</strong></p>
                  <p className="print-text">CAI (Confusion Affective) : <strong>{indices.CAI}/60</strong></p>
                  <p className="print-text">RRI (R√©silience Relationnelle) : <strong>{indices.RRI}/30</strong></p>
                </div>

                <div className="print-section">
                  <h2 className="print-subheader">Interpr√©tation clinique</h2>
                  <p className="print-text">{resultBand.text}</p>
                </div>

                <div className="print-section">
                  <h2 className="print-subheader">Scores par phase</h2>
                  {PHASES.map(phase => {
                    const score = phaseScores[phase.key];
                    const max = 30;
                    const percentage = Math.round((score / max) * 100);
                    return (
                      <div key={phase.key} className="print-score-box">
                        <p className="print-text"><strong>{phase.label}</strong> : {score}/{max} ({percentage}%)</p>
                        <p className="print-text" style={{paddingLeft: '8px', fontSize: '10px'}}>{phase.description}</p>
                      </div>
                    );
                  })}
                </div>

                <div className="print-section">
                  <h2 className="print-subheader">Indices compl√©mentaires</h2>
                  <p className="print-text">
                    <strong>CAI (Confusion Affective Indice)</strong> : {indices.CAI}/60 ‚Äî Combinaison phases 3 et 4, mesure la d√©stabilisation et le contr√¥le.
                  </p>
                  <p className="print-text">
                    <strong>RRI (R√©silience Relationnelle Indice)</strong> : {indices.RRI}/30 ‚Äî Score invers√© phase 5, capacit√© de reconstruction pr√©serv√©e.
                  </p>
                </div>

                <div className="print-section">
                  <h2 className="print-subheader">Recommandations</h2>
                  {resultBand.recommendations.map((rec, idx) => (
                    <p key={idx} className="print-reco">{idx + 1}. {rec}</p>
                  ))}
                </div>

                {/* D√âTAIL COMPLET DES QUESTIONS PAR PHASE */}
                <div className="print-section" style={{pageBreakBefore: 'always'}}>
                  <h2 className="print-header">D√©tail des r√©ponses par phase</h2>
                  
                  {PHASES.map(phase => {
                    const phaseQuestions = QUESTIONS.filter(q => q.dim === phase.key);
                    return (
                      <div key={phase.key} className="print-phase-section">
                        <h3 className="print-subheader">{phase.label}</h3>
                        {phaseQuestions.map(q => {
                          const answer = CHOICES.find(c => c.value === answers[q.id]);
                          return (
                            <div key={q.id} className="print-question">
                              <p className="print-text">
                                <strong>{q.id}</strong> : {q.text}
                              </p>
                              <p className="print-text" style={{paddingLeft: '16px', color: '#4b5563'}}>
                                ‚Üí R√©ponse : <strong>{answer?.label || 'Non r√©pondu'}</strong> ({answer?.anchor || ''})
                              </p>
                            </div>
                          );
                        })}
                      </div>
                    );
                  })}
                </div>

                <div className="print-section" style={{marginTop: '20px', paddingTop: '12px', borderTop: '1px solid #e2e8f0'}}>
                  <p className="print-text" style={{fontSize: '10px', color: '#64748b'}}>
                    NO√âSIS ‚Äî Red Flags : √âvaluation par Phase v1.0 ‚Ä¢ ¬© 2025 ‚Ä¢ Outil de rep√©rage relationnel, ne remplace pas un diagnostic professionnel
                  </p>
                  <p className="print-text" style={{fontSize: '10px', color: '#64748b'}}>
                    R√©f√©rences : Bowlby (attachement), Herman (trauma complexe), Hirigoyen (emprise), Carnes (trauma bonding), Bancroft (contr√¥le coercitif), Gottman (dynamiques relationnelles)
                  </p>
                </div>
              </div>
            </div>
          </div>
        );
      }
    }

    // ============================================================
    // RENDU DANS LE DOM
    // ============================================================

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<RedFlagsTest />);
  </script>
</body>
</html>
